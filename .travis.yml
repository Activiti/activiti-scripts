language: java
jdk: openjdk11

services:
  - docker

env:
  global:
    - SONATYPE_DIR=$HOME/.sonatype
before_install:
  - echo $GPG_SECRET_KEYS | base64 --decode | $GPG_EXECUTABLE --import
  - echo $GPG_OWNERTRUST | base64 --decode | $GPG_EXECUTABLE --import-ownertrust
  - echo BRANCH=${TRAVIS_PULL_REQUEST_BRANCH:-${TRAVIS_BRANCH}}
  - mkdir -p $HOME/.m2
  - cp settings.xml $HOME/.m2
  - mkdir -p $SONATYPE_DIR

cache:
  directories:
    - ~/.m2/repository
    - ~/.sonatype
stages:
  - Create tag
  - Prepare release
  - Release

jobs:
  include:
    - stage: Create tag
      if: commit_message =~ /\[Release\] .+/
      script: ./create-tag.sh
    - stage: Prepare release
      if: tag =~ /v7\..+/
      script:
        - ./create-staging-repository.sh
        - ./clone-all.sh
    - stage: Release
      if: tag =~ /v7\..+/
      script: ./release-ci.sh
